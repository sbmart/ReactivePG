# ReactivePG
###Реактивное общение с постгресом. 
  
##Прикладная задача:
Большое количество кассовых аппаратов отправляют на сервер данные об оперативных продажах, 
где они консолидируются для дальнейшей обработки.
Передаются JSONы в REST запросах, состав передаваемого пакета:
cashid        Айдишник кассового аппарата
chcknumber    Номер чека в открытой смене кассового аппарата
SKU           Артикул продаваемого товара
barcode       Штрихкод, сканируемый POS системой в момент продажи
name          Наименование продаваемого товара
qty           Количество
baseprice     Цена товарной единицы
discountprice Цена со скидкой, если таковая имеется.

Окружение: Scala 2.11.7; SBT 13.8; Play 2.4.6; postgres 9.4.5; postgresql-async 0.2.18; flyway-play 2.2.1; scalikejdbc-async 0.5.+;
Либа flyway-play отвечает за эволюции БД, профит по сравнению со стандартными средствами - отсутствие даунтайма при
эволюциях, те обновление БД происходит во время работы.
scalikejdbc-async-play-plugin является контейнером пула соединений с БД
Объект /app/models/Sells.scala использует либу scalikejdbc-async для "реактивной" записи события в БД

Сам процесс выглядит примерно след. образом:
1. При запросе на http://localhost:9000/sells выделяется тред для обработки WEB запроса
2. Последующему SQL запросу выделяется еще один тред
3. Тред обработки веб запроса освобождается, при этом само Веб соединение не закрывается.
4. Тред обработки SQL запроса освобождается, при этом само SQL соединение не закрывается.
5. Обработчику ответа SQL выделяется тред.
6. SQL преобразуется в List[Sells]
7. SQL тред освобождается
8. Обработчику ответа веб выделяется тред.
9. Из списка List[Sells] формируется веб ответ
10. Тред веб ответа освобождается.
Благодаря пунктам 3-4 во время обработки в БД треды(ресурсы) не блокируются в ожидании ответа


запрос для теста записи события в базу может быть таким:
$ curl -X POST -d {"cashid=19895", "chcknumber=263", "SKU=ABX15-63", "barcode=1234567890123", "name=СуперМегаПротоШтука", "qty=3", "baseprice=100500", "discountprice=95500" } http://localhost:9000/sells

